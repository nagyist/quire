{% comment %}
Duplicates part of the code from q-cite.html in order to add
references to the page-level bibliography list
{% endcomment %}

{% for reference in references %}
  {% assign id = reference %}
  {% assign full = nil %}
  {% assign short = nil %}
  {% assign alphaOrder = nil %}
  {% assign cited = "" | split: "," %}

  {% for item in references.entries %}
    {% if item.id == id %}
      {% assign cited = cited | push: item %}
    {% endif %}
  {% endfor %}

{% endfor %}

{% if cited %}
  <div class="quire-page__content__references backmatter">
    {% if config.params.biblioHeading %}<h2 id="{{ config.params.biblioHeading | slugify }}">{{ config.params.biblioHeading }}</h2>{% endif %}
    {% if config.params.displayBiblioShort == true %}
      <dl>
        {% for item in cited | sort: 'sort, full' %}
          {% comment %}
          the id is in a span because Pandoc otherwise strips them out from dt and dd for EPUBs for some reason
          {% endcomment %}

          <dt><span id="{{ item.id | slugify }}">{{ item.short | markdownify }}</span></dt>
          <dd>{{ item.full | markdownify }}</dd>
        {% endfor %}
      </dl>
    {% else %}
      <ul>
        {% for item in cited | sort %}
          <li id="{{ item.id | slugify }}">
          {% if item.full %}{{ item.full | markdownify }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
{% endif %}
